<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0110-packaging - </title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="affix"><a href="introduction.html">Introduction</a></li><li><a href="0001-transform-attribute-meta-parameter.html">0001-transform-attribute-meta-parameter</a></li><li><a href="0003-block-params.html">0003-block-params</a></li><li><a href="0003-cli-ember-doctor.html">0003-cli-ember-doctor</a></li><li><a href="0010-engines.html">0010-engines</a></li><li><a href="0011-improved-cp-syntax.html">0011-improved-cp-syntax</a></li><li><a href="0012-help-json-output.html">0012-help-json-output</a></li><li><a href="0015-the-road-to-ember-2-0.html">0015-the-road-to-ember-2-0</a></li><li><a href="0020-sri-default.html">0020-sri-default</a></li><li><a href="0023-command-line-completion.html">0023-command-line-completion</a></li><li><a href="0024-bound-attributes.html">0024-bound-attributes</a></li><li><a href="0028-app-import-output-file.html">0028-app-import-output-file</a></li><li><a href="0029-addon-black-and-whitelist-for-apps.html">0029-addon-black-and-whitelist-for-apps</a></li><li><a href="0045-internet-explorer.html">0045-internet-explorer</a></li><li><a href="0046-cli-improved-release-process.html">0046-cli-improved-release-process</a></li><li><a href="0046-registry-reform.html">0046-registry-reform</a></li><li><a href="0050-cli-production-code-stripping.html">0050-cli-production-code-stripping</a></li><li><a href="0050-improved-actions.html">0050-improved-actions</a></li><li><a href="0053-helpers.html">0053-helpers</a></li><li><a href="0055-anonymous-amd.html">0055-anonymous-amd</a></li><li><a href="0056-improved-release-cycle.html">0056-improved-release-cycle</a></li><li><a href="0057-ember-data-reference-unification.html">0057-ember-data-reference-unification</a></li><li><a href="0058-helper-listing.html">0058-helper-listing</a></li><li><a href="0061-ember-data-background-fetch.html">0061-ember-data-background-fetch</a></li><li><a href="0064-contextual-component-lookup.html">0064-contextual-component-lookup</a></li><li><a href="0065-deprecation-warning-handlers.html">0065-deprecation-warning-handlers</a></li><li><a href="0080-serve-file-api.html">0080-serve-file-api</a></li><li><a href="0086-firefox-in-ci.html">0086-firefox-in-ci</a></li><li><a href="0090-addon-tree-caching.html">0090-addon-tree-caching</a></li><li><a href="0091-cli-addon-instrumentation-experimental-hooks.html">0091-cli-addon-instrumentation-experimental-hooks</a></li><li><a href="0091-weakmap.html">0091-weakmap</a></li><li><a href="0092-blueprint-remove-old-files.html">0092-blueprint-remove-old-files</a></li><li><a href="0095-cli-standardise-targets.html">0095-cli-standardise-targets</a></li><li><a href="0095-router-service.html">0095-router-service</a></li><li><a href="0096-enable-yarn-usage.html">0096-enable-yarn-usage</a></li><li><a href="0101-ember-data-friendly-errors.html">0101-ember-data-friendly-errors</a></li><li><a href="0105-addons-optionalDependencies.html">0105-addons-optionalDependencies</a></li><li><a href="0108-add-custom-transform.html">0108-add-custom-transform</a></li><li><a href="0110-packaging.html" class="active">0110-packaging</a></li><li><a href="0114-add-template-lint-addon.html">0114-add-template-lint-addon</a></li><li><a href="0116-qunit-dom.html">0116-qunit-dom</a></li><li><a href="0120-cli-guides.html">0120-cli-guides</a></li><li><a href="0120-route-serializers.html">0120-route-serializers</a></li><li><a href="0121-remove-ember-cli-eslint.html">0121-remove-ember-cli-eslint</a></li><li><a href="0136-contains-to-includes.html">0136-contains-to-includes</a></li><li><a href="0139-isHtmlSafe.html">0139-isHtmlSafe</a></li><li><a href="0143-module-unification.html">0143-module-unification</a></li><li><a href="0150-factory-for.html">0150-factory-for</a></li><li><a href="0176-javascript-module-api.html">0176-javascript-module-api</a></li><li><a href="0178-deprecate-ember-k.html">0178-deprecate-ember-k</a></li><li><a href="0181-deprecate-ember-data-initializers.html">0181-deprecate-ember-data-initializers</a></li><li><a href="0186-track-unique-history-location-state.html">0186-track-unique-history-location-state</a></li><li><a href="0191-deprecate-component-lifecycle-hook-args.html">0191-deprecate-component-lifecycle-hook-args</a></li><li><a href="0194-deprecate-custom-event-manager.html">0194-deprecate-custom-event-manager</a></li><li><a href="0213-custom-components.html">0213-custom-components</a></li><li><a href="0225-ember-engines-mount-params.html">0225-ember-engines-mount-params</a></li><li><a href="0226-named-blocks.html">0226-named-blocks</a></li><li><a href="0229-deprecate-testing-restricted-resolver.html">0229-deprecate-testing-restricted-resolver</a></li><li><a href="0232-simplify-qunit-testing-api.html">0232-simplify-qunit-testing-api</a></li><li><a href="0236-deprecation-ember-string.html">0236-deprecation-ember-string</a></li><li><a href="0237-deprecation-ember-map.html">0237-deprecation-ember-map</a></li><li><a href="0240-es-classes.html">0240-es-classes</a></li><li><a href="0252-browser-support-changes.html">0252-browser-support-changes</a></li><li><a href="0268-acceptance-testing-refactor.html">0268-acceptance-testing-refactor</a></li><li><a href="0272-deprecation-native-function-prototype-extensions.html">0272-deprecation-native-function-prototype-extensions</a></li><li><a href="0276-named-args.html">0276-named-args</a></li><li><a href="0278-template-only-components.html">0278-template-only-components</a></li><li><a href="0280-remove-application-wrapper.html">0280-remove-application-wrapper</a></li><li><a href="0281-es5-getters.html">0281-es5-getters</a></li><li><a href="0286-block-let-template-helper.html">0286-block-let-template-helper</a></li><li><a href="0287-promote-in-element-to-public-api.html">0287-promote-in-element-to-public-api</a></li><li><a href="0293-record-data.html">0293-record-data</a></li><li><a href="0294-optional-jquery.html">0294-optional-jquery</a></li><li><a href="0297-deprecate-ember-logger.html">0297-deprecate-ember-logger</a></li><li><a href="0300-rfc-process-update.html">0300-rfc-process-update</a></li><li><a href="0308-deprecate-property-lookup-fallback.html">0308-deprecate-property-lookup-fallback</a></li><li><a href="0311-angle-bracket-invocation.html">0311-angle-bracket-invocation</a></li><li><a href="0318-array-helper.html">0318-array-helper</a></li><li><a href="0322-deprecate-copy-copyable.html">0322-deprecate-copy-copyable</a></li><li><a href="0324-deprecate-component-isvisible.html">0324-deprecate-component-isvisible</a></li><li><a href="0326-ember-data-filter-deprecation.html">0326-ember-data-filter-deprecation</a></li><li><a href="0329-deprecated-ember-evented-in-ember-data.html">0329-deprecated-ember-evented-in-ember-data</a></li><li><a href="0331-deprecate-globals-resolver.html">0331-deprecate-globals-resolver</a></li><li><a href="0332-ember-data-record-links-and-meta.html">0332-ember-data-record-links-and-meta</a></li><li><a href="0335-deprecate-send-action.html">0335-deprecate-send-action</a></li><li><a href="0337-native-class-constructor-update.html">0337-native-class-constructor-update</a></li><li><a href="0340-deprecate-ember-merge.html">0340-deprecate-ember-merge</a></li><li><a href="0345-discord.html">0345-discord</a></li><li><a href="0364-roadmap-2018.html">0364-roadmap-2018</a></li><li><a href="0369-deprecate-computed-clobberability.html">0369-deprecate-computed-clobberability</a></li><li><a href="0370-deprecate-computed-volatile.html">0370-deprecate-computed-volatile</a></li><li><a href="0372-ember-data-model-factory-for.html">0372-ember-data-model-factory-for</a></li><li><a href="0373-Element-Modifier-Managers.html">0373-Element-Modifier-Managers</a></li><li><a href="0375-deprecate-computed-property-modifier.html">0375-deprecate-computed-property-modifier</a></li><li><a href="0386-remove-jquery.html">0386-remove-jquery</a></li><li><a href="0389-dynamic-tag-names.html">0389-dynamic-tag-names</a></li><li><a href="0391-router-helpers.html">0391-router-helpers</a></li><li><a href="0392-deprecate-component-manager-string-lookup.html">0392-deprecate-component-manager-string-lookup</a></li><li><a href="0395-ember-data-packages.html">0395-ember-data-packages</a></li><li><a href="0398-RouteInfo-Metadata.html">0398-RouteInfo-Metadata</a></li><li><a href="0403-ember-data-identifiers.html">0403-ember-data-identifiers</a></li><li><a href="0408-decorators.html">0408-decorators</a></li><li><a href="0410-tracked-properties.html">0410-tracked-properties</a></li><li><a href="0415-render-element-modifiers.html">0415-render-element-modifiers</a></li><li><a href="0416-glimmer-components.html">0416-glimmer-components</a></li><li><a href="0418-deprecate-route-render-methods.html">0418-deprecate-route-render-methods</a></li><li><a href="0421-deprecate-application-controller-props.html">0421-deprecate-application-controller-props</a></li><li><a href="0425-website-redesign.html">0425-website-redesign</a></li><li><a href="0431-guides-restructure.html">0431-guides-restructure</a></li><li><a href="0432-contextual-helpers.html">0432-contextual-helpers</a></li><li><a href="0435-modifier-splattributes.html">0435-modifier-splattributes</a></li><li><a href="0440-decorator-support.html">0440-decorator-support</a></li><li><a href="0445-deprecate-with.html">0445-deprecate-with</a></li><li><a href="0446-contribution-guides.html">0446-contribution-guides</a></li><li><a href="0449-deprecate-partials.html">0449-deprecate-partials</a></li><li><a href="0451-injection-parameter-normalization.html">0451-injection-parameter-normalization</a></li><li><a href="0452-ember-data-medium-term-plan.html">0452-ember-data-medium-term-plan</a></li><li><a href="0457-nested-lookups.html">0457-nested-lookups</a></li><li><a href="0459-angle-bracket-built-in-components.html">0459-angle-bracket-built-in-components</a></li><li><a href="0460-yieldable-named-blocks.html">0460-yieldable-named-blocks</a></li><li><a href="0461-ember-data-singleton-record-data.html">0461-ember-data-singleton-record-data</a></li><li><a href="0463-record-data-state.html">0463-record-data-state</a></li><li><a href="0465-record-data-errors.html">0465-record-data-errors</a></li><li><a href="0466-request-state-service.html">0466-request-state-service</a></li><li><a href="0468-classic-decorator.html">0468-classic-decorator</a></li><li><a href="0470-fn-helper.html">0470-fn-helper</a></li><li><a href="0471-on-modifier.html">0471-on-modifier</a></li><li><a href="0478-tracked-properties-updates.html">0478-tracked-properties-updates</a></li><li><a href="0481-component-templates-co-location.html">0481-component-templates-co-location</a></li><li><a href="0486-deprecate-mouseenter.html">0486-deprecate-mouseenter</a></li><li><a href="0487-custom-model-classes.html">0487-custom-model-classes</a></li><li><a href="0491-deprecate-disconnect-outlet.html">0491-deprecate-disconnect-outlet</a></li><li><a href="0494-async-observers.html">0494-async-observers</a></li><li><a href="0521-find-by-identifier.html">0521-find-by-identifier</a></li><li><a href="0522-default-serializers-and-adapters.html">0522-default-serializers-and-adapters</a></li><li><a href="0523-model-argument-for-route-templates.html">0523-model-argument-for-route-templates</a></li><li><a href="0554-deprecate-getwithdefault.html">0554-deprecate-getwithdefault</a></li><li><a href="0558-edition-detection.html">0558-edition-detection</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title"></h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <ul>
<li>Start Date: 2017-09-07</li>
<li>Relevant Team(s): Ember CLI</li>
<li>RFC PR: <a href="https://github.com/ember-cli/rfcs/pull/110">#110</a></li>
</ul>
<h1><a class="header" href="#summary" id="summary">Summary</a></h1>
<p>The goal of this RFC is to solidify the next version of the mechanism that
<code>ember-cli</code> uses to build final assets. It will allow for a more flexible build
pipeline for Ember applications. It also unlocks building experimental features
on top. It is a backward compatible change.</p>
<h1><a class="header" href="#motivation" id="motivation">Motivation</a></h1>
<p>The <a href="https://github.com/chadhietala/rfcs/blob/packager/active/0002-packager.md">Packager
RFC</a>
submitted by <a href="https://github.com/chadhietala">Chad Hietala</a> is a little over 2
years old. A lot of things have changed since then and it requires a revision.</p>
<p>The current application build process merges and concatenates input broccoli
trees. This behaviour is not well documented and is a tribal knowledge. While
the simplicity of this approach is nice, it doesn't allow for extension. We can
refactor our build process and provide more flexibility when desired.</p>
<p>Most importantly, the approach described below helps us achieve:</p>
<ul>
<li>defining and developing a common language around the subject</li>
<li>removing highly coupled code and streamline technical implementation (Ember
Engines and Fastboot)</li>
<li>unlock a whole different set of plugins we couldn't have before:
<ul>
<li>ability to create custom bundles (i.e per-engine and per-route bundles)</li>
<li>take advantage of <a href="https://http2.github.io/faq/#why-is-http2-multiplexed">HTTP2
multiplexing</a> and
<a href="https://www.mnot.net/blog/2014/01/30/http2_expectations#4-cache-pushing">cache
pushing</a></li>
<li>optimising plugins (JavaScript and CSS tree-shaking)</li>
</ul>
</li>
</ul>
<h1><a class="header" href="#scope" id="scope">Scope</a></h1>
<ul>
<li>New public API for customising build process and giving more granular control over
the final build output</li>
</ul>
<h1><a class="header" href="#terminology" id="terminology">Terminology</a></h1>
<ul>
<li><strong>Packaging</strong> - The process of designing, evaluating, and producing final build assets.</li>
</ul>
<h1><a class="header" href="#detailed-design" id="detailed-design">Detailed design</a></h1>
<p>The detailed design is separated in various sections so that it is easier for a
reader to understand.</p>
<h2><a class="header" href="#packaging" id="packaging">Packaging</a></h2>
<p>It gives you granular control over the final build output. It could be used in many
different ways (we are going to go over use cases below). Note, it isn't meant to be
used for &quot;postprocess&quot; transformations; &quot;postprocess&quot; is called after packaging is
finished.</p>
<p>Currently, Ember.js application and all of its depedencies get assembled under one
directory with the following structure:</p>
<pre><code class="language-ruby">bundler:js:input/
├── addon-tree-output/
├── the-app-name-folder/
├── node_modules/
└── vendor/
</code></pre>
<p>where:</p>
<ul>
<li><code>addon-tree-output</code> is a folder that contains dependencies from Ember add-ons.</li>
<li><code>the-app-name-folder</code> is a folder that contains Ember application code.</li>
<li><code>node_modules</code> is a folder that contains node dependencies.</li>
<li><code>tests</code> is a folder that contains test code.</li>
<li><code>vendor</code> is a folder that contains other dependencies.</li>
</ul>
<p>Note, for clarity purposes we should rename <code>addon-tree-output</code> to <code>addon-modules</code> as
both <code>tree</code> and <code>output</code> don't communicate well about the contents of the folder.</p>
<p>During packaging process the final output will be generated (everything that currently
resides under <code>dist/</code> folder when a developer runs <code>ember build</code>).</p>
<h3><a class="header" href="#package-api" id="package-api"><code>package</code> API</a></h3>
<p>A new public <code>package</code> method will be introduced to open up a way to customise packaging process:</p>
<pre><code class="language-javascript">// ember-cli-build.js
const EmberApp = require('ember-cli/lib/broccoli/ember-app');

module.exports = function(defaults) {
  const app = new EmberApp(defaults, {
    package(inputTree) {
      // customise `inputTree`
      // and return customised `inputTree`
    }
  });

  return app.toTree();
}
</code></pre>
<p><code>package</code> function has the following signature:</p>
<pre><code class="language-typescript">interface EmberApp {
  package(inputTree: BroccoliTree): BroccoliTree;
}
</code></pre>
<p>where <code>inputTree</code> will have the following structure:</p>
<pre><code class="language-ruby">bundler:js:input/
├── addon-modules/
├── the-app-name-folder/
├── node_modules/
├── tests/
└── vendor/
</code></pre>
<p>Note, that <code>package</code> method must return a broccoli tree.</p>
<p>This change should be behind an experiment flag, <code>PACKAGING</code>.
This will allow us to start experimenting right away and not being
tied to a particular release cycle.</p>
<p>Note, that <code>package</code> is optional. If you don't define it, you're
effectively &quot;opting out&quot; of the feature and using the default
behaviour.</p>
<h3><a class="header" href="#defaultpackager-api" id="defaultpackager-api"><code>defaultPackager</code> API</a></h3>
<p>It's important to make it easy for users to still use default Ember CLI
packaging.</p>
<p><code>defaultPackager</code> is a way for the users to access out-of-the-box packaging while
still be able to customise the final build output.</p>
<pre><code class="language-javascript">// ember-cli-build.js
const EmberApp = require('ember-cli/lib/broccoli/ember-app');
const defaultPackager = require('ember-cli-default-packager');

module.exports = function(defaults) {
  const app = new EmberApp(defaults, {
    package(inputTree) {
      // customise `inputTree`

      return defaultPackager(app, inputTree);
    }
  });

  return app.toTree();
}
</code></pre>
<p><code>defaultPackager</code> has the following signature:</p>
<pre><code class="language-typescript">function defaultPackager(app: EmberApp, inputTree: BroccoliTreel): BroccoliTree;
</code></pre>
<p><code>defaultPackager</code> must return a <code>BroccoliTree</code>.</p>
<h3><a class="header" href="#possible-usages" id="possible-usages">Possible usages</a></h3>
<h4><a class="header" href="#debuganalyse" id="debuganalyse">Debug/Analyse</a></h4>
<p>One of the applications of <code>package</code> API would be to run different analysis on the
Ember applications. Take
<a href="https://github.com/stefanpenner/broccoli-concat-analyser">broccoli-concat-analyser</a>,
for example. This could be easily incorporated into the build.</p>
<pre><code class="language-javascript">// ember-cli-build.js
const EmberApp = require('ember-cli/lib/broccoli/ember-app');
const defaultPackager = require('ember-cli-default-packager');

module.exports = function(defaults) {
  const app = new EmberApp(defaults, { });

  app.package = function(inputTree) {
    const analysedTree = new BroccoliConcatAnalyser(inputTree);

    return defaultPackager(app, analysedTree);
  }

  return app.toTree();
}
</code></pre>
<h4><a class="header" href="#static-assets-split" id="static-assets-split">Static Assets Split</a></h4>
<p>One of the techniques for improving site speed is isolating changes throughout
application deployments. Assuming  the application assets are uploaded to CDN,
the reasoning is very simple: if <code>ember.js</code> or <code>jQuery</code> (possibly along with
other third party libraries) don't change with every deployment, why bust CDN
cache for them?</p>
<h4><a class="header" href="#es6-modules" id="es6-modules">ES6 Modules</a></h4>
<p>ES6 modules are <a href="https://caniuse.com/#feat=es6-module">starting</a> to land in browsers.
This means that you can use <code>&lt;script type=&quot;module&quot; src=&quot;/my/app.js&quot;&gt;&lt;/script&gt;</code>.</p>
<p>This <a href="https://philipwalton.com/articles/deploying-es2015-code-in-production-today/">article</a> <a href="https://philipwalton.com/articles/deploying-es2015-code-in-production-today/#is-this-really-worth-the-extra-effort">explains</a> the benefits of using ES6 modules over ES2015 (smaller total file sizes, faster to parse and evaluate).</p>
<p><code>package</code> API will make it possible to package your application for both ES2015 only browsers as well
the ones with ES6 modules support.</p>
<h1><a class="header" href="#topics-for-future-rfcs" id="topics-for-future-rfcs">Topics for Future RFCs</a></h1>
<p>While working on this RFC, some ideas were brought into focus regarding existing
and new features in Ember CLI. They all likely require separate discussions in
future RFCs, but the discussion points have been included below.</p>
<h2><a class="header" href="#tree-shaking" id="tree-shaking">Tree-shaking</a></h2>
<p>Firstly, what's <em>tree-shaking</em>? AFAIK, the term
<a href="https://groups.google.com/forum/#!msg/comp.lang.lisp/6zpZsWFFW18/-z_8hHRAIf4J">originated</a>
in Lisp. The gist of the idea is &quot;how about we start using <em>only</em> the code that
we actually need?&quot;</p>
<p>Secondly, how is it different from <a href="https://en.wikipedia.org/wiki/Dead_code_elimination">Dead Code
Elimination</a>? <a href="https://twitter.com/Rich_Harris">Rich
Harris</a>
<a href="https://medium.com/@Rich_Harris/tree-shaking-versus-dead-code-elimination-d3765df85c80">offers</a>
a pretty good explanation in the context of <a href="https://rollupjs.org/">Rollup</a>. The
gist is dead code elimination happens on a final product by removing bits that
are unused. Tree-shaking is quite different - given an object we want to construct, what is the exact set of dependencies we need?.</p>
<p>With this RFC, we lay out the foundation and create a framework by which both
dead code elimination and tree-shaking code be implemented.</p>
<p>However, there are still several things that are missing:</p>
<ul>
<li><strong>Linker</strong> - Responsible for resolving and reducing the graph to a tree
containing only reachable modules.</li>
<li><strong>File System Resolver</strong> - Responsible for connecting a module name with a
file path.</li>
</ul>
<p><code>Linker</code> would be responsible for:</p>
<ul>
<li>building a minimal dependency graph as well as check for redundant edges in
the graph (more on the topic, <a href="https://en.wikipedia.org/wiki/Transitive_reduction#Graph_algorithms_for_transitive_reduction">Transitive reduction of a directed
graph</a>);</li>
<li>producing an application tree with only used modules</li>
</ul>
<p>Dependency graph represents dependencies using module names, there is a need to
be able to convert module name to file path. This is where <code>File System Resolver</code> comes in. Here's couple of examples:</p>
<pre><code class="language-javascript">fileSystemResolver.resolve('lodash') =&gt; `some-path/node_modules/lodash/lodash.js`
fileSystemResolver.resolve('ember-ajax') =&gt; `some-path/addon-modules/ember-ajax/index.js`
fileSystemResolver.resolve('ember-data') =&gt; `some-path/addon-modules/modules/ember-data/index.js`
fileSystemResolver.resolve('ember-data/-private') =&gt; `some-path/addon-modules/modules/-private.js`
</code></pre>
<p>This effort could be broken down into several phases:</p>
<ul>
<li>dead modules elimination inside of the <code>addons/</code> (application would be the
main entry point and unused modules are removed only from <code>addons/</code>)</li>
<li>dead modules elimination inside of the <code>app/</code>
<ul>
<li>removing unused components and helpers (requires analysing templates)</li>
<li>removing unused initializers/services (this likely entails work on
dependency injection layer as we would need access to a resolver resolution
map)</li>
</ul>
</li>
<li>tree-shaking (Rollup-like tree-shaking where we include <em>only</em> the code that is
used)</li>
</ul>
<p><code>Linker</code> would be able to take an <code>exclude</code> list of modules as a parameter.
Although, valuable in some situations, it should be clearly marked as advanced
API. It should be used as a last resort and serve as an &quot;escape hatch&quot;.</p>
<p>It would make sense to implement <code>Linker</code> as a strategy. Developers would be
able to &quot;opt in&quot;/&quot;opt out&quot; of optimising behaviour.</p>
<h2><a class="header" href="#deprecating-appimport-api" id="deprecating-appimport-api">Deprecating <code>app.import</code> API</a></h2>
<p>Ember applications which choose to use <code>Linker</code> strategy should be able to
remove usages of <code>app.import</code>.</p>
<h2><a class="header" href="#tools" id="tools">Tools</a></h2>
<p>With growing complexity of Ember applications, it is crucial to provide more
insights into final assets.</p>
<p>Main goals are:</p>
<ul>
<li>report raw/uglified/compressed asset sizes;
<a href="https://github.com/stefanpenner/broccoli-concat-analyser">broccoli-concat-analyser</a></li>
<li>find source code duplication across your javascript assets (enables you to
fine tune code splitting parameters to reduce bundle invalidation rates as
well as improve repeat page load performance)</li>
</ul>
<h1><a class="header" href="#how-we-teach-this" id="how-we-teach-this">How We Teach This</a></h1>
<p>This is a backward compatible change to the existing Ember CLI ecosystem. In
order to teach users how to use <code>package</code> API, we need to update the API docs
with a section for this and the best practices of when to use this. A more
general purpose blog post could be beneficial as well.</p>
<h1><a class="header" href="#drawbacks" id="drawbacks">Drawbacks</a></h1>
<p>There are several potential drawbacks that are worth noting.</p>
<p><em>Build performance</em>. There is minimal overhead in instantiating strategies and
calling methods on them and I believe this approach shouldn't degrade build
performance.</p>
<p><em>A note on add-ons</em>. Add-ons don't rely on the way Ember CLI does bundling. That
means existing build system continues to work as expected and add-ons won't have
to change their implementation.</p>
<h1><a class="header" href="#alternatives" id="alternatives">Alternatives</a></h1>
<p>This RFC allows us to customise packaging when needed.
<a href="https://webpack.js.org">Webpack</a> has become very popular in solving this
similar problem. One could implement a <code>package</code> function that would use Webpack
for packaging. Ultimately, we need something that is aware of how Ember apps are
assembled and how Ember apps utilise dependency injection that takes advantage
of existing tools. The long term plan is to have a dependency graph that is
aware of application structure so can avoid the &quot;wall of configuration&quot; that
other asset packaging systems are susceptible to.</p>
<h1><a class="header" href="#unresolved-questions" id="unresolved-questions">Unresolved questions</a></h1>
<ul>
<li>Will it increase build time?</li>
<li>Should we introduce the same API on add-on level?</li>
</ul>
<h1><a class="header" href="#thanks" id="thanks">Thanks</a></h1>
<p>Many thanks for <a href="https://github.com/stefanpenner/">@stefanpenner</a>,
<a href="https://github.com/rwjblue/">@rwjblue</a> and
<a href="https://github.com/chadhietala/">@chadhietala</a> for helping me to drive this
forward.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="0108-add-custom-transform.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="0114-add-template-lint-addon.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="0108-add-custom-transform.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="0114-add-template-lint-addon.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
